/*! */
W.define("store-settings",["http","recents","dataSpecifications","utils","broadcast","storage","store","rootScope","products","favs","log","geolocation"],function(e,t,s,r,i,n,a,o,g,l,d,c){var u=l.getArray(),w=n.get("webGLtest3"),f=n.get("promos2"),v=Object.keys(t.getAll()),m=a.get("firstUserSession"),p=Object.keys(d.clientLog).sort().map(function(e){return e+": "+d.clientLog[e]}).join("\n"),h=a.getDeviceID(),y=n.get("favsLastBackup")||0,S=c.getMyLatestPos(),b={deviceId:h,minifest:g.ecmwf.refTime(),localStorage:n.isAvbl,firstSession:new Date(m).toISOString(),url:window.location.href,ua:window.navigator.userAgent,ver:o.version,target:o.target,user:o.user&&o.user.username,session:o.sessionCounter,lang:a.get("usedLang"),retina:o.isRetina,size:window.screen.width+"x"+window.screen.height,screenWidth:window.screen.width,screenHeight:window.screen.height,glParticles:o.glParticlesOn,platform:o.platform,cc:a.get("country"),place:S.name,positionSource:S.source,favs:u.length,alerts:u.filter(function(e){return"alert"===e.type}).length,favAds:u.filter(function(e){return"airport"===e.type}).length,webGL:w&&w.status,promos:f&&JSON.stringify(f),recents:v.length,isImperial:a.get("isImperial"),loadingTime:o.loadedTime-W.startTs,renderingTime:o.renderedTime-o.loadedTime,missingLang:o.missingLang,browserLang:o.prefLang,device2:o.isMobile?"mobile":o.isTablet?"tablet":"desktop",stat:p};b.daysWithUs=Math.round((Date.now()-m)/(24*r.tsHour))+1,b.seesionsPerDay=o.sessionCounter/b.daysWithUs;var L=n.get("version");if(L?L!==o.version&&(b.install="upgrade",b.upgradeFrom=L):b.install="install",n.put("version",o.version),window.device&&(b.manufacturer=window.device.manufacturer,b.model=window.device.model),"index"===W.target&&(window.top!==window.self?b.target="unlegalIframe":/Android.* wv\)/.test(window.navigator.userAgent)?b.target="unlegalWebView":window.cordova&&(b.target="unlegalCordova")),n.isAvbl){try{r.each(s,function(e,t){var s="settings_"+t;if(e&&e.save&&s in localStorage&&!/email|country|session/i.test(t)){var r=n.get(s);if(null===r)return;b[s]=r!==Object(r)?r:Array.isArray(r)?r.length:"Object"}})}catch(e){b.note="key in localStorage failed"}["rateDialogShown","storedSettings","storedFavs","lastSyncableUpdatedItem","favs_ts","recents4_ts"].forEach(function(e){var t=n.get(e);t&&(b[e]=new Date(t).toISOString())})}e.post("/sedlina/settings",{data:b});var A=Date.now();!o.user&&u.length>1&&A-y>168*r.tsHour&&(n.put("favsLastBackup",A),e.post("/users/favsBackup",{data:{version:2,user:h,data:l.data,storeTs:A}})),i.emit("settingsStored",b)});